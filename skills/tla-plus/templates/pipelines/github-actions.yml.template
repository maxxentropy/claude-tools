# GitHub Actions Workflow: TLA+ Formal Verification
#
# Generated by: tla-plus skill
# Template version: 1.0.0
#
# This workflow runs TLC model checker on all TLA+ specifications to verify
# system invariants and catch concurrency bugs.

name: TLA+ Verification

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'specs/tla+/**'
{{#each MAPPED_SOURCE_PATHS}}
      - '{{this}}'
{{/each}}
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'specs/tla+/**'
{{#each MAPPED_SOURCE_PATHS}}
      - '{{this}}'
{{/each}}

env:
  TLA_VERSION: '{{TLC_VERSION}}'
  JAVA_VERSION: '17'
  SPECS_DIR: '{{SPECS_DIR}}'

jobs:
  # Quick verification for all PRs
  simulation-check:
    name: Quick Verification (Simulation)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download TLA+ Tools
        run: |
          mkdir -p ${{ env.SPECS_DIR }}/.tools
          curl -sL -o ${{ env.SPECS_DIR }}/.tools/tla2tools.jar \
            "https://github.com/tlaplus/tlaplus/releases/download/v${{ env.TLA_VERSION }}/tla2tools.jar"

      - name: Run TLC Simulation
        run: |
          chmod +x ${{ env.SPECS_DIR }}/.tools/run-tlc.sh
          ${{ env.SPECS_DIR }}/.tools/run-tlc.sh --all --ci

      - name: Upload Verification Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tla-verification-results
          path: ${{ env.SPECS_DIR }}
          retention-days: 7

  # Thorough verification for protected branches
  thorough-verification:
    name: Thorough Verification (Full BFS)
    runs-on: ubuntu-latest
    needs: simulation-check
    timeout-minutes: {{TIMEOUT_MINUTES}}
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download TLA+ Tools
        run: |
          mkdir -p ${{ env.SPECS_DIR }}/.tools
          curl -sL -o ${{ env.SPECS_DIR }}/.tools/tla2tools.jar \
            "https://github.com/tlaplus/tlaplus/releases/download/v${{ env.TLA_VERSION }}/tla2tools.jar"

      - name: Run Thorough Verification
        run: |
{{#each MODELS}}
          echo "Verifying {{name}} (large config)..."
          ${{ env.SPECS_DIR }}/.tools/run-tlc.sh {{name}} --large --ci
{{/each}}

  # Negative testing - verify buggy variants fail
  negative-tests:
    name: Verify Bug Detection
    runs-on: ubuntu-latest
    needs: simulation-check
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download TLA+ Tools
        run: |
          mkdir -p ${{ env.SPECS_DIR }}/.tools
          curl -sL -o ${{ env.SPECS_DIR }}/.tools/tla2tools.jar \
            "https://github.com/tlaplus/tlaplus/releases/download/v${{ env.TLA_VERSION }}/tla2tools.jar"

{{#each BUGGY_MODELS}}
      - name: Verify {{name}} Fails (Expected)
        run: |
          cd ${{ env.SPECS_DIR }}/{{directory}}

          # Run buggy model - it SHOULD fail
          if java -XX:+UseParallelGC -jar ../.tools/tla2tools.jar \
              -config {{config}} {{spec}} 2>&1; then
            echo "ERROR: Buggy model {{name}} passed when it should have failed!"
            exit 1
          else
            echo "SUCCESS: TLC correctly detected the bug in {{name}}."
            exit 0
          fi
{{/each}}

  # Summary
  summary:
    name: Verification Summary
    runs-on: ubuntu-latest
    needs: [simulation-check, thorough-verification, negative-tests]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "========================================="
          echo "TLA+ Verification Summary"
          echo "========================================="
          echo "Simulation Check: ${{ needs.simulation-check.result }}"
          echo "Thorough Verification: ${{ needs.thorough-verification.result }}"
          echo "Negative Tests: ${{ needs.negative-tests.result }}"
          echo "========================================="

          if [ "${{ needs.simulation-check.result }}" != "success" ]; then
            echo "Simulation check failed!"
            exit 1
          fi

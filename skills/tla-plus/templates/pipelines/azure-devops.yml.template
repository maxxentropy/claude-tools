# Azure DevOps Pipeline: TLA+ Formal Verification
#
# Generated by: tla-plus skill
# Template version: 1.0.0
#
# This pipeline runs TLC model checker on all TLA+ specifications to verify
# system invariants and catch concurrency bugs.
#
# Triggers:
# - Changes to specs/tla+/**
# - Changes to mapped source files (see paths below)
#
# Verification Strategy:
# - PRs: Simulation mode (fast, ~100k behaviors)
# - main/develop: Full BFS verification
# - Negative testing: Verify buggy variants fail

trigger:
  branches:
    include:
      - main
      - develop
      - feature/*
  paths:
    include:
      - specs/tla+/**
{{#each MAPPED_SOURCE_PATHS}}
      - {{this}}
{{/each}}

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - specs/tla+/**
{{#each MAPPED_SOURCE_PATHS}}
      - {{this}}
{{/each}}

pool:
  vmImage: 'ubuntu-latest'

variables:
  TLA_VERSION: '{{TLC_VERSION}}'
  JAVA_VERSION: '17'
  SPECS_DIR: '{{SPECS_DIR}}'
  SIMULATION_DEPTH: '{{SIMULATION_DEPTH}}'
  TIMEOUT_MINUTES: '{{TIMEOUT_MINUTES}}'

stages:
  - stage: TLAVerification
    displayName: 'TLA+ Formal Verification'
    jobs:
      # Quick verification for all PRs
      - job: SimulationCheck
        displayName: 'Quick Verification (Simulation)'
        timeoutInMinutes: 10
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java $(JAVA_VERSION)'
            inputs:
              versionSpec: '$(JAVA_VERSION)'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - script: |
              echo "Downloading TLA+ tools v$(TLA_VERSION)..."
              mkdir -p $(SPECS_DIR)/.tools
              curl -sL -o $(SPECS_DIR)/.tools/tla2tools.jar \
                "https://github.com/tlaplus/tlaplus/releases/download/v$(TLA_VERSION)/tla2tools.jar"
              ls -la $(SPECS_DIR)/.tools/
            displayName: 'Download TLA+ Tools'

          - script: |
              echo "Running TLA+ simulation verification..."
              chmod +x $(SPECS_DIR)/.tools/run-tlc.sh
              $(SPECS_DIR)/.tools/run-tlc.sh --all --ci
            displayName: 'Verify All Models (Simulation)'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Verification Results'
            inputs:
              PathtoPublish: '$(SPECS_DIR)'
              ArtifactName: 'tla-verification-results'
            condition: always()

      # Thorough verification for protected branches
      - job: ThoroughVerification
        displayName: 'Thorough Verification (Full BFS)'
        dependsOn: SimulationCheck
        timeoutInMinutes: $(TIMEOUT_MINUTES)
        condition: and(succeeded(), or(
          eq(variables['Build.SourceBranch'], 'refs/heads/main'),
          eq(variables['Build.SourceBranch'], 'refs/heads/develop')))
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java $(JAVA_VERSION)'
            inputs:
              versionSpec: '$(JAVA_VERSION)'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - script: |
              mkdir -p $(SPECS_DIR)/.tools
              curl -sL -o $(SPECS_DIR)/.tools/tla2tools.jar \
                "https://github.com/tlaplus/tlaplus/releases/download/v$(TLA_VERSION)/tla2tools.jar"
            displayName: 'Download TLA+ Tools'

          - script: |
              echo "Running thorough TLA+ verification..."
{{#each MODELS}}
              echo "Verifying {{name}} (large config)..."
              $(SPECS_DIR)/.tools/run-tlc.sh {{name}} --large --ci
{{/each}}
            displayName: 'Verify All Models (Large Config)'

      # Negative testing - verify buggy variants fail
      - job: NegativeTests
        displayName: 'Verify Bug Detection'
        dependsOn: SimulationCheck
        timeoutInMinutes: 10
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java $(JAVA_VERSION)'
            inputs:
              versionSpec: '$(JAVA_VERSION)'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - script: |
              mkdir -p $(SPECS_DIR)/.tools
              curl -sL -o $(SPECS_DIR)/.tools/tla2tools.jar \
                "https://github.com/tlaplus/tlaplus/releases/download/v$(TLA_VERSION)/tla2tools.jar"
            displayName: 'Download TLA+ Tools'

{{#each BUGGY_MODELS}}
          - script: |
              echo "Verifying that TLC detects bugs in {{name}}..."
              cd $(SPECS_DIR)/{{directory}}

              # Run buggy model - it SHOULD fail
              if java -XX:+UseParallelGC -jar ../.tools/tla2tools.jar \
                  -config {{config}} {{spec}} 2>&1; then
                echo "ERROR: Buggy model {{name}} passed when it should have failed!"
                echo "This means the model checker is not detecting the expected bug."
                exit 1
              else
                echo "SUCCESS: TLC correctly detected the bug in {{name}}."
                echo "This confirms our model checker can catch this type of issue."
                exit 0
              fi
            displayName: 'Verify {{name}} Fails (Expected)'
{{/each}}

      # Summary job
      - job: Summary
        displayName: 'Verification Summary'
        dependsOn:
          - SimulationCheck
          - ThoroughVerification
          - NegativeTests
        condition: always()
        steps:
          - script: |
              echo "========================================="
              echo "TLA+ Verification Summary"
              echo "========================================="
              echo "Simulation Check: $(dependencies.SimulationCheck.result)"
              echo "Thorough Verification: $(dependencies.ThoroughVerification.result)"
              echo "Negative Tests: $(dependencies.NegativeTests.result)"
              echo "========================================="

              # Fail if any job failed
              if [ "$(dependencies.SimulationCheck.result)" != "Succeeded" ]; then
                echo "Simulation check failed!"
                exit 1
              fi
            displayName: 'Print Summary'

#!/usr/bin/env bash
#
# claude-skills - Manage Claude Code skills
#
# Usage:
#   claude-skills list              List installed skills
#   claude-skills check             Verify all skills are properly installed
#   claude-skills info <skill>      Show details about a skill
#   claude-skills install <zip>     Install skill from zip file
#

SKILLS_DIR="${HOME}/.claude/skills"
GLOBAL_CLAUDE="${HOME}/CLAUDE.md"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

usage() {
    echo "Usage: claude-skills <command> [args]"
    echo ""
    echo "Commands:"
    echo "  list              List installed skills"
    echo "  check             Verify all skills are properly installed"
    echo "  info <skill>      Show details about a skill"
    echo "  install <zip>     Install skill from zip file"
    echo "  triggers          List all trigger words"
    echo ""
}

list_skills() {
    echo -e "${BLUE}Installed Skills:${NC}"
    echo ""
    
    if [ ! -d "$SKILLS_DIR" ]; then
        echo -e "${YELLOW}No skills directory found at $SKILLS_DIR${NC}"
        return 1
    fi
    
    for skill_dir in "$SKILLS_DIR"/*/; do
        if [ -d "$skill_dir" ]; then
            skill_name=$(basename "$skill_dir")
            
            if [ -f "${skill_dir}SKILL.md" ]; then
                echo -e "  ${GREEN}✓${NC} $skill_name"
                
                # Try to extract description from SKILL.md
                if head -5 "${skill_dir}SKILL.md" | grep -q "^#"; then
                    desc=$(head -5 "${skill_dir}SKILL.md" | grep "^#" | head -1 | sed 's/^#* *//')
                    echo -e "    ${desc}"
                fi
            else
                echo -e "  ${YELLOW}?${NC} $skill_name (missing SKILL.md)"
            fi
        fi
    done
    echo ""
}

check_skills() {
    echo -e "${BLUE}Checking skill installations...${NC}"
    echo ""
    
    local all_ok=true
    
    # Check skills directory
    if [ ! -d "$SKILLS_DIR" ]; then
        echo -e "${RED}✗${NC} Skills directory missing: $SKILLS_DIR"
        all_ok=false
    else
        echo -e "${GREEN}✓${NC} Skills directory exists"
    fi
    
    # Check global CLAUDE.md
    if [ ! -f "$GLOBAL_CLAUDE" ]; then
        echo -e "${RED}✗${NC} Global CLAUDE.md missing: $GLOBAL_CLAUDE"
        all_ok=false
    else
        echo -e "${GREEN}✓${NC} Global CLAUDE.md exists"
    fi
    
    echo ""
    
    # Check each skill
    for skill_dir in "$SKILLS_DIR"/*/; do
        if [ -d "$skill_dir" ]; then
            skill_name=$(basename "$skill_dir")
            echo -e "${BLUE}Checking: $skill_name${NC}"
            
            # Check SKILL.md
            if [ -f "${skill_dir}SKILL.md" ]; then
                echo -e "  ${GREEN}✓${NC} SKILL.md exists"
            else
                echo -e "  ${RED}✗${NC} SKILL.md missing"
                all_ok=false
            fi
            
            # Check scripts directory
            if [ -d "${skill_dir}scripts" ]; then
                script_count=$(find "${skill_dir}scripts" -name "*.py" -o -name "*.sh" | wc -l)
                echo -e "  ${GREEN}✓${NC} scripts/ directory ($script_count scripts)"
                
                # Check scripts are executable or at least valid
                for script in "${skill_dir}scripts"/*.py; do
                    if [ -f "$script" ]; then
                        if python3 -m py_compile "$script" 2>/dev/null; then
                            echo -e "    ${GREEN}✓${NC} $(basename "$script")"
                        else
                            echo -e "    ${RED}✗${NC} $(basename "$script") - syntax error"
                            all_ok=false
                        fi
                    fi
                done
            fi
            
            # Check if registered in CLAUDE.md
            if [ -f "$GLOBAL_CLAUDE" ]; then
                if grep -q "$skill_name" "$GLOBAL_CLAUDE"; then
                    echo -e "  ${GREEN}✓${NC} Registered in CLAUDE.md"
                else
                    echo -e "  ${YELLOW}!${NC} Not registered in CLAUDE.md"
                fi
            fi
            
            echo ""
        fi
    done
    
    if $all_ok; then
        echo -e "${GREEN}All checks passed!${NC}"
    else
        echo -e "${RED}Some issues found. See above.${NC}"
        return 1
    fi
}

skill_info() {
    local skill_name="$1"
    
    if [ -z "$skill_name" ]; then
        echo "Usage: claude-skills info <skill-name>"
        return 1
    fi
    
    local skill_dir="${SKILLS_DIR}/${skill_name}"
    
    if [ ! -d "$skill_dir" ]; then
        echo -e "${RED}Skill not found: $skill_name${NC}"
        echo "Available skills:"
        ls -1 "$SKILLS_DIR" 2>/dev/null || echo "  (none)"
        return 1
    fi
    
    echo -e "${BLUE}Skill: $skill_name${NC}"
    echo -e "Location: $skill_dir"
    echo ""
    
    # Show SKILL.md header
    if [ -f "${skill_dir}/SKILL.md" ]; then
        echo -e "${BLUE}Description:${NC}"
        head -20 "${skill_dir}/SKILL.md"
        echo "..."
        echo ""
    fi
    
    # List contents
    echo -e "${BLUE}Contents:${NC}"
    find "$skill_dir" -type f | sed "s|$skill_dir/||" | sort
}

install_skill() {
    local zip_file="$1"
    
    if [ -z "$zip_file" ]; then
        echo "Usage: claude-skills install <path-to-skill.zip>"
        return 1
    fi
    
    if [ ! -f "$zip_file" ]; then
        echo -e "${RED}File not found: $zip_file${NC}"
        return 1
    fi
    
    # Create skills directory if needed
    mkdir -p "$SKILLS_DIR"
    
    echo -e "${BLUE}Installing from: $zip_file${NC}"
    
    # Extract to skills directory
    unzip -o "$zip_file" -d "$SKILLS_DIR"
    
    echo ""
    echo -e "${GREEN}Installed!${NC}"
    echo ""
    echo -e "${YELLOW}Next steps:${NC}"
    echo "1. Update ~/CLAUDE.md with the skill's triggers"
    echo "2. Check the skill's CLAUDE-global-update.md for the entry to add"
    echo "3. Run 'claude-skills check' to verify installation"
}

list_triggers() {
    echo -e "${BLUE}All Skill Triggers:${NC}"
    echo ""
    
    for skill_dir in "$SKILLS_DIR"/*/; do
        if [ -d "$skill_dir" ] && [ -f "${skill_dir}SKILL.md" ]; then
            skill_name=$(basename "$skill_dir")
            echo -e "${GREEN}$skill_name:${NC}"
            
            # Try to extract triggers from SKILL.md
            # Look for lines with trigger words
            grep -i "trigger" "${skill_dir}SKILL.md" | head -5 | sed 's/^/  /'
            echo ""
        fi
    done
}

# Main
case "${1:-}" in
    list)
        list_skills
        ;;
    check)
        check_skills
        ;;
    info)
        skill_info "$2"
        ;;
    install)
        install_skill "$2"
        ;;
    triggers)
        list_triggers
        ;;
    *)
        usage
        ;;
esac
